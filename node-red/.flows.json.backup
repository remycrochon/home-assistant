[{"id":"99c8e0165e0d303e","type":"tab","label":"Router","disabled":false,"info":"","env":[]},{"id":"c264ab8a3c4ca4d1","type":"tab","label":"Flow 1","disabled":false,"info":"","env":[]},{"id":"5544e4706ca98521","type":"tab","label":"Victron","disabled":false,"info":"","env":[]},{"id":"8e22460d.5d4bc8","type":"tab","label":"Alexa","disabled":false,"info":""},{"id":"a61e6adce9060188","type":"tab","label":"Router V2","disabled":false,"info":"","env":[]},{"id":"9d85448634dd4c1a","type":"tab","label":"Flow 2","disabled":false,"info":"","env":[]},{"id":"afdd3f75bf28d333","type":"tab","label":"PID","disabled":false,"info":"","env":[]},{"id":"12c9ac63ed800ed0","type":"subflow","name":"Subflow 1","info":"","in":[{"x":100,"y":140,"wires":[{"id":"ec719d4d.0d54f8"}]}],"out":[{"x":760,"y":320,"wires":[{"id":"ede39236.1961f8","port":0}]}]},{"id":"2923591e.104216","type":"tls-config","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"venus-ca.crt","servername":"","verifyservercert":true,"alpnprotocol":""},{"id":"45bc8be7.a4f0a4","type":"server","name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"404e1c1.65f5de4","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#333333","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Routeur","hideToolbar":"false","allowSwipe":"false","lockMenu":"true","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"1c38fbb7.3f203c","type":"mqtt-broker","name":"MQTT Victron","broker":"192.168.0.86","port":"1883","tls":"2923591e.104216","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"3","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"35ebc542aeecc309","type":"ui_tab","name":"Victron","icon":"dashboard","disabled":false,"hidden":false},{"id":"dedd34935ebbcdc1","type":"ui_group","name":"Router V1","tab":"35ebc542aeecc309","order":2,"disp":true,"width":"6","collapse":false,"className":""},{"id":"51584e3c2cfaa393","type":"alexa-smart-home-v3-conf","username":"rem81","mqttserver":"mq-red.cb-net.co.uk","webapiurl":"red.cb-net.co.uk","contextName":"memory"},{"id":"af1b6fc455ed5ad2","type":"modbus-client","name":"Victron","clienttype":"tcp","bufferCommands":true,"stateLogEnabled":false,"queueLogEnabled":false,"failureLogEnabled":true,"tcpHost":"192.168.0.86","tcpPort":"502","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB","serialType":"RTU-BUFFERD","serialBaudrate":"9600","serialDatabits":"8","serialStopbits":"1","serialParity":"none","serialConnectionDelay":"100","serialAsciiResponseStartDelimiter":"0x3A","unit_id":1,"commandDelay":1,"clientTimeout":1000,"reconnectOnTimeout":true,"reconnectTimeout":2000,"parallelUnitIdsAllowed":true,"showWarnings":true,"showLogs":true},{"id":"0bdb21264cfecccd","type":"ui_group","name":"Routeur V2","tab":"35ebc542aeecc309","order":4,"disp":true,"width":"6","collapse":false,"className":""},{"id":"13956cf323d720cd","type":"ui_group","name":"Reseau Elec","tab":"35ebc542aeecc309","order":1,"disp":true,"width":"6","collapse":false,"className":""},{"id":"89831f1002789b6c","type":"mqtt-broker","name":"","broker":"192.168.0.37","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"378299f3e47d4d20","type":"ui_group","name":"Simulation","tab":"35ebc542aeecc309","order":3,"disp":true,"width":"6","collapse":false,"className":""},{"id":"2b7ac01b.fc984","type":"ui_group","name":"SENSORS","tab":"99ab8dc5.f435c","order":1,"disp":true,"width":"6","collapse":false},{"id":"99ab8dc5.f435c","type":"ui_tab","name":"HTTP","icon":"dashboard","order":1,"disabled":false,"hidden":false},{"id":"7fe4b5c3.32e58c","type":"function","z":"12c9ac63ed800ed0","name":"30 sec RC + 20","func":"// Applies a simple RC low pass filter to incoming payload values\nvar tc = 30*1000;       // time constant in milliseconds\n\nvar lastValue = context.get('lastValue');\nif (typeof lastValue == \"undefined\") lastValue = msg.payload;\nvar lastTime = context.get('lastTime') || null;\nvar now = new Date();\nvar currentValue = msg.payload;\nif (lastTime === null) {\n    // first time through\n    newValue = currentValue;\n} else {\n    var dt = now - lastTime;\n    var newValue;\n    \n    if (dt > 0) {\n        var dtotc = dt / tc;\n        newValue = lastValue * (1 - dtotc) + currentValue * dtotc;\n    } else {\n        // no time has elapsed leave output the same as last time\n        newValue = lastValue;\n    }\n}\ncontext.set('lastValue', newValue);\ncontext.set('lastTime', now);\n\nmsg.payload = newValue + 20;\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":240,"wires":[["ae1a6e5.d4c0d9"]]},{"id":"1bacd004.9753c","type":"inject","z":"12c9ac63ed800ed0","name":"Inject -0.2 at start","repeat":"","crontab":"","once":true,"topic":"","payload":"-0.2","payloadType":"num","x":188,"y":63,"wires":[["ec719d4d.0d54f8"]]},{"id":"999a52c2.f465f","type":"function","z":"12c9ac63ed800ed0","name":"10 sec RC","func":"// Applies a simple RC low pass filter to incoming payload values\nvar tc = 10*1000;       // time constant in milliseconds\n\nvar lastValue = context.get('lastValue');\nif (typeof lastValue == \"undefined\") lastValue = msg.payload;\nvar lastTime = context.get('lastTime') || null;\nvar now = new Date();\nvar currentValue = msg.payload;\nif (lastTime === null) {\n    // first time through\n    newValue = currentValue;\n} else {\n    var dt = now - lastTime;\n    var newValue;\n    \n    if (dt > 0) {\n        var dtotc = dt / tc;\n        newValue = lastValue * (1 - dtotc) + currentValue * dtotc;\n    } else {\n        // no time has elapsed leave output the same as last time\n        newValue = lastValue;\n    }\n}\ncontext.set('lastValue', newValue);\ncontext.set('lastTime', now);\n\nmsg.payload = newValue;\nreturn msg;","outputs":1,"noerr":0,"x":504.5,"y":240,"wires":[["7fe4b5c3.32e58c"]]},{"id":"ec719d4d.0d54f8","type":"delay","z":"12c9ac63ed800ed0","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":321.5,"y":137,"wires":[["ede39236.1961f8"]]},{"id":"a823c9cf.2a6178","type":"function","z":"12c9ac63ed800ed0","name":"2 msg transport delay","func":"// stores messages in a fifo until the specified number have been received, \n// then releases them as new messages are received.\n// during the filling phase the earliest message is passed on each time \n// a message is received, but it is also left in the fifo\nvar fifoMaxLength = 2;\nvar fifo = context.get('fifo') || [];\n// push the new message onto the top of the array, messages are shifted down and\n// drop off the front\nvar length = fifo.push(msg);  // returns new length\nif (length > fifoMaxLength) {\n    newMsg = fifo.shift();\n} else {\n    // not full yet, make a copy of the msg and pass it on\n    var newMsg = JSON.parse(JSON.stringify(fifo[0]));\n}\ncontext.set('fifo', fifo);\nreturn newMsg;","outputs":1,"noerr":0,"x":340,"y":300,"wires":[["999a52c2.f465f"]]},{"id":"ae1a6e5.d4c0d9","type":"function","z":"12c9ac63ed800ed0","name":"Clear all except payload","func":"msg2 = {payload: msg.payload};\nreturn msg2;","outputs":1,"noerr":0,"x":598.5,"y":326,"wires":[[]]},{"id":"ede39236.1961f8","type":"range","z":"12c9ac63ed800ed0","minin":"0","maxin":"100","minout":"-100","maxout":"100","action":"scale","round":false,"property":"payload","name":"","x":150.5,"y":241,"wires":[["a823c9cf.2a6178"]]},{"id":"d5bb5a6fbe8a8900","type":"http request","z":"99c8e0165e0d303e","name":"","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[{"keyType":"msg","keyValue":"payload","valueType":"other","valueValue":""}],"x":710,"y":100,"wires":[[]]},{"id":"f3351be463b175be","type":"function","z":"99c8e0165e0d303e","name":"function 1","func":"var value=msg.payload;\n\nif (value < 0) {\n    value = 0;\n} else if (value > 100) {\n    value = 100;\n}\n\n\nmsg.payload = \"http://192.168.0.77/?POWER=\"+value;\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":80,"wires":[["5317965d8acbf016"]]},{"id":"5317965d8acbf016","type":"change","z":"99c8e0165e0d303e","name":"","rules":[{"t":"set","p":"url","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":140,"wires":[["d5bb5a6fbe8a8900","efd318f8.965d28","e7032485600e2013"]]},{"id":"1ae1ff1136b1ce65","type":"debug","z":"99c8e0165e0d303e","name":"M_Dimmer","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":710,"y":340,"wires":[]},{"id":"90a44f2c9d4a8c4d","type":"debug","z":"99c8e0165e0d303e","name":"PU grid","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":360,"y":260,"wires":[]},{"id":"efd318f8.965d28","type":"debug","z":"99c8e0165e0d303e","name":"URL","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":730,"y":160,"wires":[]},{"id":"3215c48483a96014","type":"function","z":"99c8e0165e0d303e","name":"Calcul Sortie % V1","func":"var pu = Math.abs(msg.pu);\nvar pu_net = msg.pu;\nvar S_Triac;\nvar Pas_Triac;\nvar M_Triac;\nvar Palier0 = 0;\nvar Palier1 = 15;\nvar Palier2 = 50;\nvar Palier3 = 100;\nvar Palier4 = 200;\nvar Palier5 = 300;\nvar Palier6 = 600;\nvar Palier7 = 900;\nvar etat = msg.dimmer; // Etat dimmer\n\nif (etat === \"on\") {\n\n    if (global.get('M_Triac') === undefined) {\n        global.set('M_Triac', 0);\n    }\n    S_Triac = global.get('M_Triac')\n\n    if (pu >= Palier1 && pu < Palier2) {\n        Pas_Triac = 0.5;\n    }\n    else if (pu >= Palier2 && pu < Palier3) {\n        Pas_Triac = 1;\n    }\n    else if (pu >= Palier3 && pu < Palier4) {\n        Pas_Triac = 1.5;\n    }\n    else if (pu >= Palier4 && pu < Palier5) {\n        Pas_Triac = 2;\n    }\n    else if (pu >= Palier5 && pu < Palier6) {\n        Pas_Triac = 2.5;\n    }\n    else if (pu >= Palier6 && pu < Palier7) {\n        Pas_Triac = 3;\n    }\n    else if (pu >= Palier7) {\n        Pas_Triac = 4;\n    }\n    else {\n        Pas_Triac = 0;\n    }\n\n    if (pu_net < 0) {\n        S_Triac = S_Triac + Pas_Triac;\n    } else {\n        S_Triac = S_Triac - Pas_Triac;\n    }\n\n    if (S_Triac < 1) {\n        S_Triac = 0;\n    }\n    if (S_Triac > 100) {\n        S_Triac = 100;\n    }\n    global.set('M_Triac', S_Triac);\n\n} else {\n    S_Triac = 0;\n    global.set('M_Triac', 0)\n    Pas_Triac = 0;\n}\nS_Triac = Math.trunc(S_Triac);\nmsg.payload = \"http://192.168.0.77/?POWER=\" + S_Triac;\n\nvar msg2 = { payload: Pas_Triac }\nvar msg3 = { payload: S_Triac }\nreturn [msg, msg2, msg3];","outputs":3,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":380,"wires":[["22e31288a0961075","5317965d8acbf016"],["1ae1ff1136b1ce65","46f7a8fd5e230c2f"],["d94c0ff96671f33a","bf0712cff0298b48","7185a70ff57c283a"]]},{"id":"46f7a8fd5e230c2f","type":"ui_gauge","z":"99c8e0165e0d303e","name":"","group":"dedd34935ebbcdc1","order":1,"width":"3","height":"3","gtype":"gage","title":"M_Dimmer","label":"Unité","format":"{{value}}","min":0,"max":"20","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","diff":false,"className":"","x":710,"y":400,"wires":[]},{"id":"d94c0ff96671f33a","type":"ui_gauge","z":"99c8e0165e0d303e","name":"","group":"dedd34935ebbcdc1","order":2,"width":"3","height":"3","gtype":"gage","title":"Sortie V1","label":"%","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","diff":false,"className":"","x":700,"y":440,"wires":[]},{"id":"8a52316c884dd04e","type":"modbus-read","z":"99c8e0165e0d303e","name":"Pu grid","topic":"Pu_grid","showStatusActivities":true,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"HoldingRegister","adr":"820","quantity":"1","rate":"2","rateUnit":"s","delayOnStart":false,"startDelayTime":"5","server":"af1b6fc455ed5ad2","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":true,"x":90,"y":200,"wires":[["d4c7e3e3.526538"],[]]},{"id":"d4c7e3e3.526538","type":"function","z":"99c8e0165e0d303e","name":"Convertion","func":"// Entrée : msg.payload (entier non signé)\n// Sortie : msg.payload (entier signé)\n\n// Récupérer la valeur de l'entier non signé\nvar unsignedInt = msg.payload;\n\n// Créer un tableau tampon (Buffer) pour stocker les données\nvar buffer = Buffer.allocUnsafe(2);\n\n// Écrire la valeur de l'entier non signé dans le tampon\nbuffer.writeUInt16BE(unsignedInt, 0);\n\n// Lire la valeur de l'entier signé depuis le tampon\nvar signedInt = buffer.readInt16BE(0);\n\n// Mettre à jour la valeur du message avec l'entier signé\nmsg.payload = signedInt;\n\n// Renvoyer le message modifié\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":130,"y":300,"wires":[["90a44f2c9d4a8c4d","af31ae510b0e868b","62c4bfac1802aab7","be258b9d8eefcd93"]]},{"id":"d485d8cc726be5c8","type":"ui_slider","z":"99c8e0165e0d303e","name":"","label":"Simul Sortie","tooltip":"","group":"378299f3e47d4d20","order":2,"width":0,"height":0,"passthru":true,"outs":"all","topic":"topic","topicType":"msg","min":"0","max":"100","step":1,"className":"","x":110,"y":80,"wires":[["f3351be463b175be"]]},{"id":"af31ae510b0e868b","type":"ui_chart","z":"99c8e0165e0d303e","name":"","group":"13956cf323d720cd","order":2,"width":0,"height":0,"label":"Pu Réseau","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"5","removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"className":"","x":710,"y":260,"wires":[[]]},{"id":"e7032485600e2013","type":"ui_text","z":"99c8e0165e0d303e","group":"dedd34935ebbcdc1","order":4,"width":0,"height":0,"name":"","label":"Trame","format":"{{msg.payload}}","layout":"row-spread","className":"","x":690,"y":220,"wires":[]},{"id":"bf0712cff0298b48","type":"ui_chart","z":"99c8e0165e0d303e","name":"","group":"dedd34935ebbcdc1","order":3,"width":0,"height":0,"label":"Sortie GV1","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"15","removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"className":"","x":710,"y":480,"wires":[[]]},{"id":"b746980fc02e1b13","type":"ui_slider","z":"99c8e0165e0d303e","name":"","label":"Simul Puissance","tooltip":"","group":"378299f3e47d4d20","order":1,"width":0,"height":0,"passthru":true,"outs":"all","topic":"topic","topicType":"msg","min":"-1000","max":"1000","step":1,"className":"","x":130,"y":140,"wires":[["3215c48483a96014"]]},{"id":"be258b9d8eefcd93","type":"change","z":"99c8e0165e0d303e","name":"payload->Pu->dimmer","rules":[{"t":"set","p":"pu","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"dimmer","pt":"msg","to":"dimmer","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":200,"y":380,"wires":[["3215c48483a96014","4a67d9420a504268"]]},{"id":"621b588ed3d71afe","type":"debug","z":"99c8e0165e0d303e","name":"triac","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":690,"y":700,"wires":[]},{"id":"f531da7a37f7ebd6","type":"comment","z":"99c8e0165e0d303e","name":"Routeur PV","info":"","x":390,"y":40,"wires":[]},{"id":"62c4bfac1802aab7","type":"ui_gauge","z":"99c8e0165e0d303e","name":"","group":"13956cf323d720cd","order":1,"width":"3","height":"3","gtype":"gage","title":"Pu reseau","label":"W","format":"{{value}}","min":"-1000","max":"1000","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","diff":false,"className":"","x":710,"y":300,"wires":[]},{"id":"03ef1f935e2eee14","type":"change","z":"99c8e0165e0d303e","name":"","rules":[{"t":"set","p":"mem_triac","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":700,"wires":[["621b588ed3d71afe"]]},{"id":"4f24a19d6940b130","type":"inject","z":"99c8e0165e0d303e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"2","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":700,"wires":[["c9fcbbebddd301cf"]]},{"id":"c9fcbbebddd301cf","type":"random","z":"99c8e0165e0d303e","name":"","low":"0","high":"1000","inte":"true","property":"payload","x":320,"y":700,"wires":[["03ef1f935e2eee14"]]},{"id":"7cb9ae6d6afcc285","type":"api-current-state","z":"99c8e0165e0d303e","name":"Etat Dimmer","server":"45bc8be7.a4f0a4","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"switch.dimmer_on_off_4630","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":330,"y":640,"wires":[["cbdd0dd936be204e"]]},{"id":"c2f4344b01701c5e","type":"inject","z":"99c8e0165e0d303e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"5","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":640,"wires":[["7cb9ae6d6afcc285"]]},{"id":"cbdd0dd936be204e","type":"change","z":"99c8e0165e0d303e","name":"","rules":[{"t":"set","p":"dimmer","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":640,"wires":[[]]},{"id":"4a67d9420a504268","type":"debug","z":"99c8e0165e0d303e","name":"Dimmer","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"dimmer","targetType":"msg","statusVal":"payload","statusType":"auto","x":360,"y":440,"wires":[]},{"id":"8c30bf26420a78a1","type":"function","z":"99c8e0165e0d303e","name":"Calcul Sortie % V2","func":"var pu_net = msg.pu;\nvar S_Triac;\nvar P_Routage = -10;\nvar M_Triac;\nvar P_dimmer1 = 1;\nvar P_dimmer2 = 0.1;\nvar P_dimmer3 = 1;\nvar M_dimmer = 0;\nvar etat = msg.dimmer; // Etat dimmer\n\nif (etat === \"on\") {\n    if (global.get('M_Triac') === undefined) {\n        global.set('M_Triac', 0);\n    }\n    S_Triac = global.get('M_Triac');\n\n    if (pu_net == 0) {\n        S_Triac = 0;\n        M_dimmer = 0;\n    }\n\n    if (pu_net <= -400 && S_Triac < 95) {\n        S_Triac = S_Triac + P_dimmer3;\n        M_dimmer = P_dimmer3;\n    }\n    if (pu_net > -400 && pu_net <= -150 && S_Triac < 99) {\n        S_Triac = S_Triac + P_dimmer1;\n        M_dimmer = P_dimmer1;\n    }\n\n    if (pu_net <= P_Routage && pu_net > -150 && S_Triac < 99.99) {\n        S_Triac = S_Triac + P_dimmer2;\n        M_dimmer = P_dimmer2;\n    }\n\n    if (pu_net > P_Routage && pu_net <= 30 && S_Triac > 0.01) {\n        S_Triac = S_Triac - P_dimmer2;\n        M_dimmer = P_dimmer2;\n    }\n\n    if (pu_net > 30 && S_Triac > 1 && pu_net <= 150) {\n        S_Triac = S_Triac - P_dimmer1;\n        M_dimmer = P_dimmer1;\n    }\n\n    if (pu_net > 150 && S_Triac > 5) {\n        S_Triac = S_Triac - P_dimmer3;\n        M_dimmer = P_dimmer3;\n    }\n\n    if (S_Triac < 1) {\n        S_Triac = 0;\n        M_dimmer = 0;\n    }\n    if (S_Triac > 100) {\n        S_Triac = 100;\n        M_dimmer = 0;\n    }\n    global.set('M_Triac', S_Triac);\n\n} else {\n    S_Triac = 0;\n    global.set('M_Triac', 0)\n    M_dimmer = 0;\n}\nS_Triac = Math.trunc(S_Triac);\nmsg.payload = \"http://192.168.0.77/?POWER=\" + S_Triac;\n\nvar msg2 = { payload: M_dimmer }\nvar msg3 = { payload: S_Triac }\nreturn [msg, msg2, msg3];","outputs":3,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":780,"wires":[[],[],[]]},{"id":"91861f76c5297b6a","type":"function","z":"99c8e0165e0d303e","name":"Calcul Sortie % V1","func":"var pu = Math.abs(msg.pu);\nvar pu_net = msg.pu;\nvar S_Triac;\nvar Pas_Triac;\nvar M_Triac;\nvar Palier0 = -15;\nvar Palier1 = 15;\nvar Palier2 = 50;\nvar Palier3 = 100;\nvar Palier4 = 200;\nvar Palier5 = 300;\nvar Palier6 = 600;\nvar Palier7 = 900;\nvar etat = msg.dimmer; // Etat dimmer\n\nif (etat === \"on\") {\n\n    if (global.get('M_Triac') === undefined) {\n        global.set('M_Triac', 0);\n    }\n    S_Triac = global.get('M_Triac')\n\n    if (pu >= Palier1 && pu < Palier2) {\n        Pas_Triac = 0.5;\n    }\n    else if (pu >= Palier2 && pu < Palier3) {\n        Pas_Triac = 1;\n    }\n    else if (pu >= Palier3 && pu < Palier4) {\n        Pas_Triac = 1.5;\n    }\n    else if (pu >= Palier4 && pu < Palier5) {\n        Pas_Triac = 2;\n    }\n    else if (pu >= Palier5 && pu < Palier6) {\n        Pas_Triac = 2.5;\n    }\n    else if (pu >= Palier6 && pu < Palier7) {\n        Pas_Triac = 3;\n    }\n    else if (pu >= Palier7) {\n        Pas_Triac = 4;\n    }\n    else {\n        Pas_Triac = 0;\n    }\n\n    if (pu_net < 0) {\n        S_Triac = S_Triac + Pas_Triac;\n    } else {\n        S_Triac = S_Triac - Pas_Triac;\n    }\n\n    if (S_Triac < 1) {\n        S_Triac = 0;\n    }\n    if (S_Triac > 100) {\n        S_Triac = 100;\n    }\n    global.set('M_Triac', S_Triac);\n\n} else {\n    S_Triac = 0;\n    global.set('M_Triac', 0)\n    Pas_Triac = 0;\n}\nS_Triac = Math.trunc(S_Triac);\nmsg.payload = \"http://192.168.0.77/?POWER=\" + S_Triac;\n\nvar msg2 = { payload: Pas_Triac }\nvar msg3 = { payload: S_Triac }\nreturn [msg, msg2, msg3];","outputs":3,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":780,"wires":[[],[],[]]},{"id":"22e31288a0961075","type":"debug","z":"99c8e0165e0d303e","name":"debug 10","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":480,"y":200,"wires":[]},{"id":"7185a70ff57c283a","type":"debug","z":"99c8e0165e0d303e","name":"S_Triac","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":680,"y":540,"wires":[]},{"id":"9a612871fbc9576b","type":"debug","z":"99c8e0165e0d303e","name":"debug 11","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":480,"y":540,"wires":[]},{"id":"c3c21ef795fdee28","type":"change","z":"99c8e0165e0d303e","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"M_Triac","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":540,"wires":[["9a612871fbc9576b"]]},{"id":"d671545a0b0c25b3","type":"inject","z":"99c8e0165e0d303e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"1","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":110,"y":560,"wires":[["c3c21ef795fdee28","0f23156229d8b278"]]},{"id":"0f23156229d8b278","type":"random","z":"99c8e0165e0d303e","name":"","low":"-500","high":"+500","inte":"true","property":"payload","x":140,"y":460,"wires":[[]]},{"id":"ad042517224504af","type":"change","z":"99c8e0165e0d303e","name":"","rules":[{"t":"set","p":"M_Triac","pt":"global","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":600,"wires":[[]]},{"id":"d6f986432b09b89b","type":"inject","z":"99c8e0165e0d303e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":600,"wires":[["ad042517224504af"]]},{"id":"d8e7f05e940dc2e7","type":"server-state-changed","z":"99c8e0165e0d303e","name":"Pu ECS","server":"45bc8be7.a4f0a4","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.ecocompteur_ecs","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":230,"y":840,"wires":[["1aebcf25b682c527","b2f5c0663b22a6dd"]]},{"id":"1aebcf25b682c527","type":"ui_chart","z":"99c8e0165e0d303e","name":"","group":"13956cf323d720cd","order":2,"width":0,"height":0,"label":"Pu ECS","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"5","removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"className":"","x":640,"y":840,"wires":[[]]},{"id":"b2f5c0663b22a6dd","type":"ui_gauge","z":"99c8e0165e0d303e","name":"","group":"13956cf323d720cd","order":1,"width":"3","height":"3","gtype":"gage","title":"Pu ECS","label":"W","format":"{{value}}","min":"0","max":"3000","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","diff":false,"className":"","x":640,"y":880,"wires":[]},{"id":"c7410fa2.1c2fa","type":"debug","z":"c264ab8a3c4ca4d1","name":"Striac","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":650,"y":260,"wires":[]},{"id":"6530621.95b429c","type":"http in","z":"c264ab8a3c4ca4d1","d":true,"name":"","url":"/triac","method":"get","upload":false,"swaggerDoc":"","x":100,"y":191,"wires":[["55b8d747ed7af8ed"]]},{"id":"5ddc9f47.4b555","type":"http response","z":"c264ab8a3c4ca4d1","name":"","statusCode":"200","headers":{},"x":640,"y":140,"wires":[]},{"id":"9471d1a0.68588","type":"function","z":"c264ab8a3c4ca4d1","name":"","func":"var triac = msg.sort_triac;\nmsg.payload = { \"value\": triac };\nvar msg2 = { payload: triac }   \nreturn [msg, msg2];\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":200,"wires":[["5ddc9f47.4b555","13aea59.7430e5a"],["c7410fa2.1c2fa"]]},{"id":"13aea59.7430e5a","type":"debug","z":"c264ab8a3c4ca4d1","name":"D2","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":650,"y":200,"wires":[]},{"id":"e71c7a7d.e7c598","type":"debug","z":"c264ab8a3c4ca4d1","name":"D1","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"s_triac","targetType":"msg","statusVal":"payload","statusType":"auto","x":630,"y":60,"wires":[]},{"id":"55b8d747ed7af8ed","type":"change","z":"c264ab8a3c4ca4d1","name":"","rules":[{"t":"set","p":"sort_triac","pt":"msg","to":"mem_triac","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":140,"wires":[["9471d1a0.68588","e71c7a7d.e7c598"]]},{"id":"76206bdc11bd8af0","type":"mqtt out","z":"5544e4706ca98521","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1c38fbb7.3f203c","x":690,"y":300,"wires":[]},{"id":"a5f6b90183627a18","type":"inject","z":"5544e4706ca98521","name":"SOC CP0","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/0/Soc","payload":"{\"value\": 65}","payloadType":"json","x":480,"y":360,"wires":[["76206bdc11bd8af0"]],"info":"{\"value\": 7}"},{"id":"78f64487024701ce","type":"debug","z":"5544e4706ca98521","name":"IB CP1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":700,"y":360,"wires":[]},{"id":"57520f7ea386dbdd","type":"mqtt out","z":"5544e4706ca98521","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1c38fbb7.3f203c","x":690,"y":80,"wires":[]},{"id":"ab1d9f219b647ef3","type":"inject","z":"5544e4706ca98521","name":"Valid CP0","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/0/Day","payload":"{\"value\": 7}","payloadType":"json","x":480,"y":80,"wires":[["57520f7ea386dbdd"]],"info":"{\"value\": 7}"},{"id":"6253fca74afec021","type":"mqtt out","z":"5544e4706ca98521","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1c38fbb7.3f203c","x":690,"y":220,"wires":[]},{"id":"41eb4e711ecbae9c","type":"inject","z":"5544e4706ca98521","name":"DeValid CP0","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/0/Day","payload":"{\"value\": -7}","payloadType":"json","x":490,"y":220,"wires":[["6253fca74afec021"]],"info":"{\"value\": 7}"},{"id":"6ee74f5ab966b69a","type":"server-state-changed","z":"5544e4706ca98521","name":"Valid ESS MP1","server":"45bc8be7.a4f0a4","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.mp2_valid_ess_charge_prog_1","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":200,"wires":[["c9662efb4e21d816"]]},{"id":"080afd12087fa185","type":"debug","z":"5544e4706ca98521","name":"CP0 ON","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":700,"y":140,"wires":[]},{"id":"fad23d31bd455893","type":"debug","z":"5544e4706ca98521","name":"CP0 OFF","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":700,"y":180,"wires":[]},{"id":"c9662efb4e21d816","type":"function","z":"5544e4706ca98521","name":"function 1","func":"var msg1 = { topic: \"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/0/Day\", payload: { \"value\": 7 } };\nvar msg2 = { topic: \"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/0/Day\", payload: { \"value\": -7 } };\nif (msg.payload === \"on\") {\n    return [msg1];\n}\n\nif (msg.payload === \"off\") {\n   return [msg2];\n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":140,"wires":[["57520f7ea386dbdd","080afd12087fa185"],["6253fca74afec021","fad23d31bd455893"]]},{"id":"45397e9ba0da9a9b","type":"server-state-changed","z":"5544e4706ca98521","name":"Niveau SOC CP1","server":"45bc8be7.a4f0a4","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_number.mp2_niveau_soc_cp1","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"topic","propertyType":"msg","value":"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/0/Soc","valueType":"str"},{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":120,"y":260,"wires":[["a9ca66afd11bac34"]]},{"id":"31015289423ab064","type":"function","z":"5544e4706ca98521","name":"function 2","func":"msg.payload = {\"value\": msg.payload} ;\nmsg.topic = \"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/0/Soc\";\nreturn [msg];\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":300,"wires":[["78f64487024701ce","76206bdc11bd8af0"]]},{"id":"a9ca66afd11bac34","type":"change","z":"5544e4706ca98521","name":"convert","rules":[{"t":"set","p":"payload","pt":"msg","to":"$number($$.payload)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":300,"wires":[["31015289423ab064"]]},{"id":"683f5e1eda028bac","type":"comment","z":"5544e4706ca98521","name":"Charge Programmée 1","info":"# # Devalidation ESS","x":360,"y":40,"wires":[]},{"id":"16a5750b052f21ae","type":"mqtt out","z":"5544e4706ca98521","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1c38fbb7.3f203c","x":710,"y":680,"wires":[]},{"id":"1545b5553b016a81","type":"inject","z":"5544e4706ca98521","name":"SOC CP1","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/1/Soc","payload":"{\"value\": 65}","payloadType":"json","x":500,"y":740,"wires":[["16a5750b052f21ae"]],"info":"{\"value\": 7}"},{"id":"b3a7532d557ee49f","type":"debug","z":"5544e4706ca98521","name":"IB CP1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":720,"y":740,"wires":[]},{"id":"45f435e20c082385","type":"mqtt out","z":"5544e4706ca98521","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1c38fbb7.3f203c","x":710,"y":460,"wires":[]},{"id":"d95e2f67fd9d4143","type":"inject","z":"5544e4706ca98521","name":"Valid CP1","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/1/Day","payload":"{\"value\": 7}","payloadType":"json","x":500,"y":460,"wires":[["45f435e20c082385"]],"info":"{\"value\": 7}"},{"id":"08e0d53fadeb7fc1","type":"mqtt out","z":"5544e4706ca98521","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1c38fbb7.3f203c","x":710,"y":600,"wires":[]},{"id":"6278b0435cf6df72","type":"inject","z":"5544e4706ca98521","name":"DeValid CP1","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/1/Day","payload":"{\"value\": -7}","payloadType":"json","x":510,"y":600,"wires":[["08e0d53fadeb7fc1"]],"info":"{\"value\": 7}"},{"id":"9d2ffad5db217bb6","type":"server-state-changed","z":"5544e4706ca98521","name":"Valid ESS MP2","server":"45bc8be7.a4f0a4","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.mp2_valid_ess_charge_prog_2","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":560,"wires":[["5b4f7ead9ac7e705"]]},{"id":"e1220538fbbf2b63","type":"debug","z":"5544e4706ca98521","name":"CP1 ON","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":720,"y":520,"wires":[]},{"id":"7a4619f508a12495","type":"debug","z":"5544e4706ca98521","name":"CP1 OFF","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":720,"y":560,"wires":[]},{"id":"5b4f7ead9ac7e705","type":"function","z":"5544e4706ca98521","name":"function 3","func":"var msg1 = { topic: \"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/1/Day\", payload: { \"value\": 7 } };\nvar msg2 = { topic: \"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/1/Day\", payload: { \"value\": -7 } };\nif (msg.payload === \"on\") {\n    return [msg1];\n}\n\nif (msg.payload === \"off\") {\n   return [msg2];\n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":520,"wires":[["45f435e20c082385","e1220538fbbf2b63"],["08e0d53fadeb7fc1","7a4619f508a12495"]]},{"id":"9e660e0218764dc7","type":"server-state-changed","z":"5544e4706ca98521","name":"Niveau SOC CP2","server":"45bc8be7.a4f0a4","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_number.mp2_niveau_soc_cp2","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":120,"y":620,"wires":[["c8288adc4d92874e"]]},{"id":"7bbd643bbea1e5f6","type":"function","z":"5544e4706ca98521","name":"function 4","func":"msg.payload = {\"value\": msg.payload} ;\nmsg.topic = \"W/c0619ab1db0d/settings/0/Settings/CGwacs/BatteryLife/Schedule/Charge/1/Soc\";\nreturn [msg];\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":680,"wires":[["b3a7532d557ee49f","16a5750b052f21ae"]]},{"id":"c8288adc4d92874e","type":"change","z":"5544e4706ca98521","name":"convert","rules":[{"t":"set","p":"payload","pt":"msg","to":"$number($$.payload)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":680,"wires":[["7bbd643bbea1e5f6"]]},{"id":"6963628b4987c882","type":"comment","z":"5544e4706ca98521","name":"Charge Programmée 2","info":"# # # Devalidation ESS","x":360,"y":420,"wires":[]},{"id":"a56c55eae59be75b","type":"function","z":"5544e4706ca98521","name":"function 5","func":"msg.payload = {\"value\": msg.payload} ;\nmsg.topic = \"N/c0619ab1db0d/settings/0/Settings/CGwacs/MaxDischargePower\";\nreturn [msg];\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":800,"wires":[[]]},{"id":"905e98a122a018fc","type":"mqtt out","z":"5544e4706ca98521","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1c38fbb7.3f203c","x":690,"y":840,"wires":[]},{"id":"57e42b10915e223b","type":"inject","z":"5544e4706ca98521","name":"Max Decharge Power","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"N/c0619ab1db0d/settings/0/Settings/CGwacs/MaxDischargePower","payload":"{\"value\": 85.0}","payloadType":"json","x":480,"y":900,"wires":[["905e98a122a018fc","69c84bd192b262a7"]],"info":"{\"value\": 7}"},{"id":"318edc147b83f33d","type":"inject","z":"5544e4706ca98521","name":"RAZ Decharge Power","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"N/c0619ab1db0d/settings/0/Settings/CGwacs/MaxDischargePower","payload":"{\"value\": -1.0}","payloadType":"json","x":480,"y":840,"wires":[["905e98a122a018fc","69c84bd192b262a7"]],"info":"{\"value\": 7}"},{"id":"69c84bd192b262a7","type":"debug","z":"5544e4706ca98521","name":"debug 12","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":700,"y":900,"wires":[]},{"id":"9088df4139906dff","type":"modbus-write","z":"5544e4706ca98521","name":"Max puissance Charge","showStatusActivities":false,"showErrors":false,"showWarnings":true,"unitid":"100","dataType":"HoldingRegister","adr":"2704","quantity":"1","server":"af1b6fc455ed5ad2","emptyMsgOnFail":false,"keepMsgProperties":false,"delayOnStart":false,"startDelayTime":"","x":680,"y":980,"wires":[[],[]]},{"id":"13707b07e56fdd85","type":"inject","z":"5544e4706ca98521","name":"RAZ Decharge Power","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"json","x":400,"y":960,"wires":[["9088df4139906dff","34616f30c1a0b207"]],"info":"{\"value\": 7}"},{"id":"079c1a69f9337865","type":"inject","z":"5544e4706ca98521","name":"Max Decharge Power","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"90","payloadType":"json","x":400,"y":1020,"wires":[["34616f30c1a0b207","9088df4139906dff"]],"info":"{\"value\": 7}"},{"id":"34616f30c1a0b207","type":"debug","z":"5544e4706ca98521","name":"debug 13","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":640,"y":1060,"wires":[]},{"id":"6b851733.c19458","type":"api-call-service","z":"8e22460d.5d4bc8","name":"PC Lampe Desodo","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.pc1_lidl"],"data":"{  \"entity_id\": \"switch.pc1_lidl\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":490,"y":40,"wires":[[]]},{"id":"46261335.4a1a8c","type":"api-call-service","z":"8e22460d.5d4bc8","name":"LumiereSalon_On","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.lumiere_salon"],"data":"{     \"entity_id\": \"switch.lumiere_salon\"   }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":490,"y":180,"wires":[[]]},{"id":"718d34f4.9f3efc","type":"api-call-service","z":"8e22460d.5d4bc8","name":"LumiereSalon_Off","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.lumiere_salon"],"data":"{     \"entity_id\": \"switch.lumiere_salon\"   }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":490,"y":240,"wires":[[]]},{"id":"74361e87.c60ef","type":"switch","z":"8e22460d.5d4bc8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"ON","vt":"str"},{"t":"eq","v":"OFF","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":220,"wires":[["46261335.4a1a8c"],["718d34f4.9f3efc"]]},{"id":"96df52f.32954b","type":"api-call-service","z":"8e22460d.5d4bc8","name":"Sapin_On","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.tc6_bp1"],"data":"{     \"entity_id\": \"switch.tc6_bp1\"   }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":460,"y":320,"wires":[[]]},{"id":"dcf564c0.ed00d8","type":"api-call-service","z":"8e22460d.5d4bc8","name":"Sapin_Off","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.tc6_bp1"],"data":"{     \"entity_id\": \"switch.tc6_bp1\"   }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":460,"y":400,"wires":[[]]},{"id":"e5b22860.6ff4b8","type":"switch","z":"8e22460d.5d4bc8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"ON","vt":"str"},{"t":"eq","v":"OFF","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":380,"wires":[["96df52f.32954b"],["dcf564c0.ed00d8"]]},{"id":"2816255d.87259a","type":"switch","z":"8e22460d.5d4bc8","name":"","property":"command","propertyType":"msg","rules":[{"t":"eq","v":"TurnOnRequest","vt":"str"},{"t":"eq","v":"TurnOffRequest","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":80,"wires":[["6b851733.c19458"],["3467d74a.0269c8"]]},{"id":"b5a8d80.7946728","type":"debug","z":"8e22460d.5d4bc8","name":"P1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":310,"y":580,"wires":[]},{"id":"3467d74a.0269c8","type":"api-call-service","z":"8e22460d.5d4bc8","name":"PC Lampe Desodo","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.pc1_lidl"],"data":"{     \"entity_id\": \"switch.pc1_lidl\"   }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":490,"y":100,"wires":[[]]},{"id":"f412731.839b49","type":"switch","z":"8e22460d.5d4bc8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"ON","vt":"str"},{"t":"eq","v":"OFF","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":310,"y":480,"wires":[["118aed92.1cefb2"],["c8c87646.f85928"]]},{"id":"118aed92.1cefb2","type":"api-call-service","z":"8e22460d.5d4bc8","name":"Spots terrasse","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.spots_ext_sud"],"data":"{\"entity_id\":\"switch.spots_ext_sud\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":500,"y":500,"wires":[[]]},{"id":"c8c87646.f85928","type":"api-call-service","z":"8e22460d.5d4bc8","name":"Spots terrasse","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.spots_ext_sud"],"data":"{\"entity_id\":\"switch.spots_ext_sud\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":500,"y":580,"wires":[[]]},{"id":"b2e5a71f.ce6948","type":"alexa-smart-home-v3","z":"8e22460d.5d4bc8","conf":"51584e3c2cfaa393","device":"51168","acknowledge":true,"name":"lampe salon","topic":"","x":110,"y":280,"wires":[["74361e87.c60ef"]]},{"id":"caee490f3d7be3b4","type":"alexa-smart-home-v3","z":"8e22460d.5d4bc8","conf":"51584e3c2cfaa393","device":"51169","acknowledge":true,"name":"lampe terrasse","topic":"","x":118,"y":490,"wires":[["f412731.839b49"]]},{"id":"fee29231711f705e","type":"api-call-service","z":"8e22460d.5d4bc8","name":"Ferm Volet Bureau Droit","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"script","service":"volet_bureau_droit_down","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":530,"y":660,"wires":[[]]},{"id":"c6da137185d59bf4","type":"api-call-service","z":"8e22460d.5d4bc8","name":"Ferm Volet Bureau Gauche","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"script","service":"volet_bureau_gauche_down","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":560,"y":720,"wires":[[]]},{"id":"8e86827c07b7f0d7","type":"switch","z":"8e22460d.5d4bc8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"ON","vt":"str"},{"t":"eq","v":"OFF","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":310,"y":700,"wires":[["fee29231711f705e","c6da137185d59bf4"],[]]},{"id":"4eb6d8fdad19d5de","type":"alexa-smart-home-v3","z":"8e22460d.5d4bc8","conf":"51584e3c2cfaa393","device":"51333","acknowledge":true,"name":"fermeture volet bureau","topic":"","x":140,"y":680,"wires":[["b5a8d80.7946728","8e86827c07b7f0d7"]]},{"id":"09254c2cca01b8aa","type":"alexa-smart-home-v3","z":"8e22460d.5d4bc8","conf":"51584e3c2cfaa393","device":"51256","acknowledge":true,"name":"ouverture volet bureau","topic":"","x":120,"y":760,"wires":[["52715ec13791f02e","b75aab4586ee0490"]]},{"id":"52715ec13791f02e","type":"debug","z":"8e22460d.5d4bc8","name":"P2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":350,"y":760,"wires":[]},{"id":"d712839b239413b2","type":"api-call-service","z":"8e22460d.5d4bc8","name":"Ouv Volet Bureau Gauche","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"script","service":"volet_bureau_gauche_up","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":550,"y":880,"wires":[[]]},{"id":"27ccbb2bf9344110","type":"api-call-service","z":"8e22460d.5d4bc8","name":"Ouv Volet Bureau Droit","server":"45bc8be7.a4f0a4","version":5,"debugenabled":true,"domain":"script","service":"volet_bureau_droit_up","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":540,"y":820,"wires":[[]]},{"id":"b75aab4586ee0490","type":"switch","z":"8e22460d.5d4bc8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"ON","vt":"str"},{"t":"eq","v":"OFF","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":330,"y":840,"wires":[["d712839b239413b2","27ccbb2bf9344110"],[]]},{"id":"30885855d7a11f11","type":"function","z":"a61e6adce9060188","d":true,"name":"Calcul Sortie V2","func":"var Pu = msg.pu*-1; // Valeur de la puissance réelle en watts\nvar fReservoirEnergie  = context.get('fReservoirEnergie') || 0; // Récupération de la valeur actuelle de la variable fReservoirEnergie\nvar fCyclesParSeconde =  0.5; // Valeur du nombre de cycles par seconde\nvar fMargeSecuriteWatt = 6; // Valeur de la marge de sécurité en watts\nvar iCapaciteReservoirEnergie = 3600; // Valeur de la capacité maximale du réservoir d'énergie en joule\nvar StriacMax = 100; // Valeur maximale pour le contrôle du Triac\nvar EtatDimmer = msg.dimmer; // Etat dimmer\nvar STriac;\n\nif (EtatDimmer === \"off\") {\n    // Calcul du taux de puissance à délester pour ne pas injecter avec byDim\n    fReservoirEnergie += Pu/1 / fCyclesParSeconde;\n    fReservoirEnergie -= fMargeSecuriteWatt / fCyclesParSeconde;\n\n    // Contrôle des limites min et max du réservoir virtuel\n    if (fReservoirEnergie > iCapaciteReservoirEnergie) { fReservoirEnergie = iCapaciteReservoirEnergie; }\n    if (fReservoirEnergie < 0) { fReservoirEnergie = 0; }\n\n    // Détermination de la sortie Triac\n\n    if (fReservoirEnergie <= 1300) { STriac = 0; }\n    else {\n        if (fReservoirEnergie >= 2300) { STriac=StriacMax; }\n        else { STriac = ((fReservoirEnergie - 1300) * 0.1); }\n    }\n\n    context.set('fReservoirEnergie', fReservoirEnergie); // Stockage de la nouvelle valeur de fReservoirEnergie dans le contexte de Node-RED\n} else {\n    STriac = 0;\n    context.set('fReservoirEnergie', 0);\n}\nmsg.payload = \"http://192.168.0.77/?POWER=\" + STriac;\n\nvar msg2 = { payload: fReservoirEnergie }\nvar msg3 = { payload: STriac }\nvar msg4 = { payload: (Pu*-1) }\nvar msg5 = { payload: Pu / 1 / fCyclesParSeconde }\nreturn [msg, msg2, msg3,msg4,msg5];\n","outputs":5,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":320,"wires":[["68d17a00af21929a"],["96617c6ebe84469c","dd97c9dba11bc494"],["ef06acb657b870fb","6951cd170a55596f","511ebf29dfbda8fd","3c0e81c3a2f233db","864e033b7c629e3f"],["acad28fad1a12b65"],["d608ba2426ad2416","5ed9b78aabd15016"]]},{"id":"68d17a00af21929a","type":"debug","z":"a61e6adce9060188","name":"URL","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":550,"y":220,"wires":[]},{"id":"96617c6ebe84469c","type":"debug","z":"a61e6adce9060188","name":"Res Energie","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":590,"y":280,"wires":[]},{"id":"ef06acb657b870fb","type":"debug","z":"a61e6adce9060188","name":"S %","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":570,"y":340,"wires":[]},{"id":"0be42596a2c48d95","type":"inject","z":"a61e6adce9060188","name":"0","props":[{"p":"payload"},{"p":"pu","v":"0","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":90,"y":340,"wires":[["30885855d7a11f11"]]},{"id":"dd97c9dba11bc494","type":"ui_gauge","z":"a61e6adce9060188","name":"","group":"0bdb21264cfecccd","order":2,"width":"3","height":"3","gtype":"gage","title":"Reservoir","label":"Joules","format":"{{value}}","min":0,"max":"3600","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","diff":false,"className":"","x":780,"y":280,"wires":[]},{"id":"6951cd170a55596f","type":"ui_gauge","z":"a61e6adce9060188","name":"","group":"0bdb21264cfecccd","order":1,"width":"3","height":"3","gtype":"gage","title":"Sortie V2","label":"%","format":"{{value}}","min":"0","max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","diff":false,"className":"","x":780,"y":340,"wires":[]},{"id":"511ebf29dfbda8fd","type":"ui_chart","z":"a61e6adce9060188","name":"","group":"0bdb21264cfecccd","order":4,"width":0,"height":0,"label":"Sortie GV2","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"15","removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"className":"","x":790,"y":380,"wires":[[]]},{"id":"acad28fad1a12b65","type":"debug","z":"a61e6adce9060188","name":"Pu","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":570,"y":400,"wires":[]},{"id":"32ca6708f76941e0","type":"random","z":"a61e6adce9060188","name":"","low":"-50","high":"50","inte":"true","property":"payload","x":100,"y":220,"wires":[["4ca9a0a5b9f1233b"]]},{"id":"d950b3de89cf3935","type":"inject","z":"a61e6adce9060188","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"2","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":70,"y":280,"wires":[["32ca6708f76941e0"]]},{"id":"3c0e81c3a2f233db","type":"range","z":"a61e6adce9060188","minin":"0","maxin":"100","minout":"0","maxout":"3000","action":"scale","round":true,"property":"pu","name":"","x":160,"y":460,"wires":[[]]},{"id":"18e8d9d76bc9c04b","type":"debug","z":"a61e6adce9060188","name":"debug 8","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"dimmer","targetType":"msg","statusVal":"payload","statusType":"auto","x":400,"y":460,"wires":[]},{"id":"0a1b299890bc5a12","type":"change","z":"a61e6adce9060188","name":"payload->Pu","rules":[{"t":"set","p":"pu","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":200,"wires":[["30885855d7a11f11"]]},{"id":"4ca9a0a5b9f1233b","type":"api-current-state","z":"a61e6adce9060188","name":"Etat Dimmer","server":"45bc8be7.a4f0a4","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"switch.dimmer_on_off_4630","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"dimmer","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":150,"y":140,"wires":[["0a1b299890bc5a12","18e8d9d76bc9c04b"]]},{"id":"5ed9b78aabd15016","type":"ui_numeric","z":"a61e6adce9060188","name":"","label":"Increment","tooltip":"","group":"0bdb21264cfecccd","order":3,"width":0,"height":0,"wrap":false,"passthru":true,"topic":"topic","topicType":"msg","format":"{{value}}","min":"-1500","max":"1500","step":1,"className":"","x":780,"y":440,"wires":[[]]},{"id":"d608ba2426ad2416","type":"debug","z":"a61e6adce9060188","name":"Increment","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":580,"y":460,"wires":[]},{"id":"d66e9d096ce14899","type":"http request","z":"a61e6adce9060188","name":"","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[{"keyType":"msg","keyValue":"payload","valueType":"other","valueValue":""}],"x":770,"y":20,"wires":[[]]},{"id":"1621be6bbe864318","type":"change","z":"a61e6adce9060188","name":"","rules":[{"t":"set","p":"url","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":510,"y":100,"wires":[["d66e9d096ce14899","eec54a401009d88b"]]},{"id":"eec54a401009d88b","type":"debug","z":"a61e6adce9060188","name":"URL","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":790,"y":100,"wires":[]},{"id":"864e033b7c629e3f","type":"subflow:12c9ac63ed800ed0","z":"a61e6adce9060188","name":"","x":340,"y":540,"wires":[[]]},{"id":"2332257dcdaa2872","type":"http response","z":"a61e6adce9060188","name":"","statusCode":"","headers":{},"x":510,"y":40,"wires":[]},{"id":"bbdc0e51d62cca44","type":"http in","z":"a61e6adce9060188","name":"","url":"/triacold","method":"get","upload":false,"swaggerDoc":"","x":160,"y":40,"wires":[["0ed4c80ff4a2c44b","dea0a2ddab8de44f"]]},{"id":"0ed4c80ff4a2c44b","type":"debug","z":"a61e6adce9060188","name":"debug 9","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":340,"y":100,"wires":[]},{"id":"59ff2a1.fa600d4","type":"http in","z":"a61e6adce9060188","name":"","url":"/hello","method":"get","swaggerDoc":"","x":410,"y":160,"wires":[["54c1e70d.ab3e18"]]},{"id":"54c1e70d.ab3e18","type":"template","z":"a61e6adce9060188","name":"page","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n    <head></head>\n    <body>\n        <h1>Hello World!</h1>\n    </body>\n</html>","x":560,"y":160,"wires":[["266c286f.d993d8"]]},{"id":"266c286f.d993d8","type":"http response","z":"a61e6adce9060188","name":"","x":700,"y":160,"wires":[]},{"id":"dea0a2ddab8de44f","type":"template","z":"a61e6adce9060188","name":"page","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n    <head></head>\n    <body>\n        <h1>Hello World!</h1>\n    </body>\n</html>","x":350,"y":40,"wires":[["2332257dcdaa2872"]]},{"id":"62cdbd0f360d4b1d","type":"PID","z":"afdd3f75bf28d333","name":"","setpoint":"00","pb":"50","ti":"22","td":"20","integral_default":"0","smooth_factor":"0","max_interval":600,"enable":"1","disabled_op":"0","x":350,"y":260,"wires":[["4f57fb845bee6a65"]]},{"id":"a17f0f3f1059b9b8","type":"inject","z":"afdd3f75bf28d333","name":"Setpoint 10","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"setpoint","payload":"10","payloadType":"num","x":130,"y":300,"wires":[["62cdbd0f360d4b1d"]]},{"id":"da776d3ac5fd4b13","type":"inject","z":"afdd3f75bf28d333","name":"Setpoint 0","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"setpoint","payload":"0","payloadType":"num","x":140,"y":260,"wires":[["62cdbd0f360d4b1d"]]},{"id":"2a288ac97b944cea","type":"inject","z":"afdd3f75bf28d333","name":"Setpoint -10","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"setpoint","payload":"-10","payloadType":"num","x":130,"y":220,"wires":[["62cdbd0f360d4b1d"]]},{"id":"b032daa31a1f56a5","type":"inject","z":"afdd3f75bf28d333","name":"disable","repeat":"","crontab":"","once":false,"topic":"enable","payload":"false","payloadType":"bool","x":170,"y":140,"wires":[["62cdbd0f360d4b1d"]]},{"id":"4f34f1be2d695eab","type":"inject","z":"afdd3f75bf28d333","name":"enable","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"","topic":"enable","payload":"true","payloadType":"bool","x":160,"y":80,"wires":[["62cdbd0f360d4b1d"]]},{"id":"4f57fb845bee6a65","type":"function","z":"afdd3f75bf28d333","name":"Trame","func":"var pourcentage = msg.payload*100;\nvar msg2={payload : pourcentage}\n\npourcentage = Math.trunc(pourcentage);\n\n\nmsg.payload = \"http://192.168.0.67/?POWER=\"+pourcentage;\n\n\nreturn [msg, msg2];","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":240,"wires":[["3e0b671d21d9d762"],["6e5942f55e60a9db"]]},{"id":"3e0b671d21d9d762","type":"debug","z":"afdd3f75bf28d333","name":"S PID","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":710,"y":260,"wires":[]},{"id":"eab63a89332cfc5a","type":"server-state-changed","z":"afdd3f75bf28d333","name":"Pu Grid","server":"45bc8be7.a4f0a4","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.mp2_grid_l1","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":130,"y":380,"wires":[[]]},{"id":"57fb286285db071e","type":"range","z":"afdd3f75bf28d333","minin":"0","maxin":"1","minout":"0","maxout":"100","action":"scale","round":false,"property":"payload","name":"Scale power","x":530,"y":340,"wires":[[]]},{"id":"6e5942f55e60a9db","type":"debug","z":"afdd3f75bf28d333","name":"Sortie","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":710,"y":300,"wires":[]},{"id":"637d4b27ab8b4d4f","type":"mqtt in","z":"afdd3f75bf28d333","name":"","topic":"espaltherma/ATTR","qos":"2","datatype":"auto-detect","broker":"89831f1002789b6c","nl":false,"rap":true,"rh":0,"inputs":0,"x":330,"y":460,"wires":[["760bd9738c30f005","d65513d3c401b0c9"]]},{"id":"760bd9738c30f005","type":"debug","z":"afdd3f75bf28d333","name":"debug 7","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":540,"y":460,"wires":[]},{"id":"d65513d3c401b0c9","type":"debug","z":"afdd3f75bf28d333","name":"T° Int","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload[\"Temp. ambiante intérieure (R1T)\"]","targetType":"msg","statusVal":"payload[\"Temp. ambiante intérieure (R1T)\"]","statusType":"auto","x":530,"y":500,"wires":[]}]